# 功能问题跟踪

## 🐛 待解决问题

### Issue #1: 历史笔记加载时序问题

**问题描述：**
- 在某些情况下，打开页面笔记窗口时历史笔记内容可能无法正确加载
- 可能与DOM元素创建和消息传递的时序有关

**复现步骤：**
1. 在页面创建笔记并保存
2. 关闭笔记窗口
3. 重新点击笔记按钮打开窗口
4. 观察是否自动加载了历史内容

**技术分析：**
- Content Script中`loadHistoryNotes()`调用时机可能过早
- `quickNoteModal`DOM元素可能尚未完全初始化
- Background script的消息处理可能存在异步竞争

**当前状态：** 🔧 已尝试修复，需要测试验证

**修复尝试：**
- 调整了加载历史笔记的时序，增加延迟
- 将加载逻辑放在DOM创建完成后执行

**备选方案：**
如果时序问题难以解决，可考虑：
1. 在按钮上显示"有历史笔记"的提示
2. 添加手动"加载历史笔记"按钮
3. 在窗口显示后延迟更长时间再尝试加载

---

## ✅ 已完成改进

### Feature #1: 笔记列表显示格式优化

**改进内容：**
- ✅ 时间戳前置：`[2024-01-15 14:30] 页面标题`
- ✅ 恢复选择计数：`2 selections` 徽章显示
- ✅ 兼容新旧格式：支持新的摘录格式计数
- ✅ 样式优化：更好的视觉层次和间距

**技术实现：**
- 修改`notes.js`中的`render`函数
- 支持多种摘录分隔符格式检测
- 添加专门的CSS样式优化

### Feature #2: 复制粘贴自动格式化

**功能说明：**
- ✅ 智能检测粘贴的文本类型
- ✅ 自动转换为引用格式
- ✅ 兼容不支持拖拽的网站

---

## 🤔 Manifest V3 升级影响分析

### 主要技术变化：

#### 1. **Background Scripts → Service Workers**
```javascript
// 当前 (MV2)
"background": {
  "page": "background.html"
}

// 升级后 (MV3)  
"background": {
  "service_worker": "background.js"
}
```

**影响：**
- ❌ **持久化数据访问**：Service Worker非持久运行，IndexedDB访问需要重新设计
- ❌ **全局变量**：无法使用全局变量保持状态，需要改用Storage API
- ⚠️ **生命周期管理**：需要处理Service Worker的启动/休眠周期

#### 2. **Host Permissions**
```javascript
// 当前 (MV2)
"permissions": ["tabs", "history", "storage"]

// 升级后 (MV3)
"permissions": ["storage"],
"host_permissions": ["http://*/*", "https://*/*"]
```

**影响：**
- ⚠️ **权限申请**：需要分离主机权限和API权限
- ✅ **功能影响**：主要功能不受影响

#### 3. **Content Security Policy**
```javascript
// MV3 更严格的CSP规则
"content_security_policy": {
  "extension_pages": "script-src 'self'; object-src 'self'"
}
```

**影响：**
- ❌ **内联脚本**：需要将所有内联JS移到外部文件
- ⚠️ **动态代码**：`eval()`等动态代码执行被禁止

#### 4. **核心功能影响评估**

| 功能模块 | 影响程度 | 主要变化 |
|---------|---------|----------|
| 🗂️ **历史记录管理** | 🟡 中等 | 需要重构数据库访问逻辑 |
| 📝 **笔记功能** | 🟡 中等 | Background消息处理需要重写 |
| 🎨 **UI组件** | 🟢 轻微 | Content Script基本不变 |
| 📋 **右键菜单** | 🟡 中等 | 菜单创建逻辑需要调整 |
| 💾 **数据持久化** | 🔴 严重 | IndexedDB访问模式需要重新设计 |

#### 5. **升级工作量估算**

**高优先级重构：**
- 🔴 **Background Script → Service Worker** (预计: 2-3天)
- 🔴 **数据库访问重构** (预计: 2-3天)  
- 🟡 **消息传递优化** (预计: 1天)

**中优先级调整：**
- 🟡 **权限声明更新** (预计: 0.5天)
- 🟡 **CSP合规性修复** (预计: 1天)

**总工作量：** 约 6-8 工作日

#### 6. **建议升级策略**

**阶段1：准备工作**
- 创建MV3分支进行实验
- 识别所有需要修改的文件
- 准备测试用例

**阶段2：核心重构**  
- 重写Background Script为Service Worker
- 重构数据库访问模式
- 更新权限声明

**阶段3：测试与优化**
- 全功能测试
- 性能优化
- 兼容性验证

**结论：** MV3升级有一定复杂度，主要挑战在于数据持久化和Background执行模式的改变，但功能本身可以保留。建议在当前MV2版本稳定后再考虑升级。

---

**文档版本：** 4.2.0  
**最后更新：** 2025-08-22  
**维护者：** sperwe
