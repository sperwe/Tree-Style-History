<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸˆ æµ®åŠ¨ç¬”è®°ç®¡ç†å™¨</title>
    <link rel="stylesheet" href="css/note-manager.css">
    <style>
        /* å…¨å±€æµ®åŠ¨çª—å£ä¸“ç”¨æ ·å¼ */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Helvetica, Arial, sans-serif;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
        }
        
        .floating-window-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 0.5px solid rgba(0, 0, 0, 0.08);
        }
        
        .floating-title-bar {
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.08);
            -webkit-app-region: drag;
            user-select: none;
        }
        
        .floating-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }
        
        .floating-control-btn {
            width: 13px;
            height: 13px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 500;
            color: transparent;
        }
        
        .floating-control-btn.close { background: #FF5F57; }
        .floating-control-btn.minimize { background: #FFBD2E; }
        .floating-control-btn.maximize { background: #28CA42; }
        
        .floating-control-btn:hover {
            color: rgba(0, 0, 0, 0.6);
        }
        
        .floating-title {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #1d1d1f;
            margin-right: 60px;
        }
        
        .floating-content {
            flex: 1;
            overflow: hidden;
        }
        
        /* éšè—åŸæ¥çš„"æ–°çª—å£"æŒ‰é’® */
        #open-window {
            display: none !important;
        }
        
        /* å·¥å…·æ å¾®è°ƒ */
        .toolbar {
            padding: 12px 16px;
            background: rgba(248, 249, 250, 0.8);
        }
    </style>
</head>
<body>
    <div class="floating-window-container">
        <!-- æ ‡é¢˜æ  -->
        <div class="floating-title-bar">
            <div class="floating-controls">
                <button class="floating-control-btn close" title="å…³é—­" onclick="closeFloatingWindow()">â—</button>
                <button class="floating-control-btn minimize" title="æœ€å°åŒ–" onclick="minimizeFloatingWindow()">â—</button>
                <button class="floating-control-btn maximize" title="æœ€å¤§åŒ–" onclick="toggleMaximizeFloatingWindow()">â—</button>
            </div>
            <div class="floating-title">ğŸˆ æµ®åŠ¨ç¬”è®°ç®¡ç†å™¨</div>
        </div>
        
        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="floating-content">
            <div class="note-manager-container">
                <!-- é¡¶éƒ¨å·¥å…·æ  -->
                <div class="toolbar">
                    <div class="toolbar-left">
                        <div class="search-box">
                            <input type="text" id="global-search" placeholder="ğŸ” æœç´¢ç¬”è®°æ ‡é¢˜å’Œå†…å®¹..." maxlength="100">
                            <button id="clear-search" class="clear-btn" style="display: none;">âœ–ï¸</button>
                        </div>
                    </div>
                    
                    <div class="toolbar-center">
                        <div class="filters">
                            <select id="tag-filter" title="æŒ‰æ ‡ç­¾è¿‡æ»¤">
                                <option value="">ğŸ·ï¸ å…¨éƒ¨æ ‡ç­¾</option>
                                <option value="important_very">ğŸ”¥ éå¸¸é‡è¦</option>
                                <option value="important_somewhat">ğŸ”¥ æ¯”è¾ƒé‡è¦</option>
                                <option value="important_general">ğŸ”¥ ä¸€èˆ¬é‡è¦</option>
                                <option value="interesting_very">ğŸ’¡ éå¸¸æœ‰è¶£</option>
                                <option value="interesting_somewhat">ğŸ’¡ æ¯”è¾ƒæœ‰è¶£</option>
                                <option value="interesting_general">ğŸ’¡ ä¸€èˆ¬æœ‰è¶£</option>
                                <option value="needed_very">âš¡ éå¸¸éœ€è¦</option>
                                <option value="needed_somewhat">âš¡ æ¯”è¾ƒéœ€è¦</option>
                                <option value="needed_general">âš¡ ä¸€èˆ¬éœ€è¦</option>
                            </select>
                            <select id="sort-filter" title="æ’åºæ–¹å¼">
                                <option value="time_desc">â° æœ€æ–°åœ¨å‰</option>
                                <option value="time_asc">â° æœ€æ—§åœ¨å‰</option>
                                <option value="title_asc">ğŸ”¤ æ ‡é¢˜A-Z</option>
                                <option value="title_desc">ğŸ”¤ æ ‡é¢˜Z-A</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="toolbar-right">
                        <button id="refresh-notes" class="btn" title="åˆ·æ–°ç¬”è®°åˆ—è¡¨">ğŸ”„</button>
                        <button id="new-note" class="btn btn-primary" title="æ–°å»ºç¬”è®°">ğŸ“ æ–°å»º</button>
                        <button id="toggle-preview" class="btn" title="åˆ‡æ¢é¢„è§ˆæ¨¡å¼">ğŸ‘ï¸</button>
                        <button id="import-export" class="btn" title="å¯¼å…¥å¯¼å‡º">ğŸ“¦</button>
                    </div>
                </div>

                <!-- ä¸»å†…å®¹åŒºåŸŸ -->
                <div class="main-content">
                    <!-- å·¦ä¾§ç¬”è®°åˆ—è¡¨é¢æ¿ -->
                    <div class="note-list-panel">
                        <div class="list-header">
                            <div class="list-stats">
                                <span class="stats-text">å…± <span id="total-notes">0</span> æ¡ç¬”è®°</span>
                            </div>
                            <div class="list-controls">
                                <button id="select-all-notes" class="btn-small">å…¨é€‰</button>
                                <button id="delete-selected" class="btn-small danger" style="display: none;">åˆ é™¤é€‰ä¸­</button>
                            </div>
                        </div>
                        <div class="note-list" id="note-list">
                            <!-- ç¬”è®°åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            <div class="loading-state" id="loading-notes" style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                height: 200px;
                                color: #666;
                            ">
                                <div>ğŸ”„ åŠ è½½ç¬”è®°ä¸­...</div>
                            </div>
                            <div class="empty-state" id="empty-notes" style="
                                display: none;
                                text-align: center;
                                padding: 40px 20px;
                                color: #666;
                            ">
                                <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“</div>
                                <div style="font-size: 16px; margin-bottom: 8px;">æš‚æ— ç¬”è®°</div>
                                <div style="font-size: 14px;">ç‚¹å‡»"æ–°å»º"æŒ‰é’®åˆ›å»ºä½ çš„ç¬¬ä¸€æ¡ç¬”è®°</div>
                            </div>
                        </div>
                    </div>

                    <!-- å³ä¾§ç¼–è¾‘å™¨é¢æ¿ -->
                    <div class="editor-panel">
                        <div class="editor-header">
                            <div class="note-meta" id="note-meta" style="display: none;">
                                <div class="meta-row">
                                    <span class="meta-label">ğŸ“„ é¡µé¢:</span>
                                    <span class="meta-value" id="note-url">-</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">ğŸ•’ æ—¶é—´:</span>
                                    <span class="meta-value" id="note-time">-</span>
                                </div>
                            </div>
                            <div class="title-input-container">
                                <input type="text" id="note-title" placeholder="è¾“å…¥ç¬”è®°æ ‡é¢˜..." maxlength="200">
                            </div>
                            <div class="tag-selector">
                                <label for="note-tag">ğŸ·ï¸ æ ‡ç­¾:</label>
                                <select id="note-tag">
                                    <option value="general_general">ğŸ“‹ ä¸€èˆ¬</option>
                                    <option value="important_very">ğŸ”¥ éå¸¸é‡è¦</option>
                                    <option value="important_somewhat">ğŸ”¥ æ¯”è¾ƒé‡è¦</option>
                                    <option value="important_general">ğŸ”¥ ä¸€èˆ¬é‡è¦</option>
                                    <option value="interesting_very">ğŸ’¡ éå¸¸æœ‰è¶£</option>
                                    <option value="interesting_somewhat">ğŸ’¡ æ¯”è¾ƒæœ‰è¶£</option>
                                    <option value="interesting_general">ğŸ’¡ ä¸€èˆ¬æœ‰è¶£</option>
                                    <option value="needed_very">âš¡ éå¸¸éœ€è¦</option>
                                    <option value="needed_somewhat">âš¡ æ¯”è¾ƒéœ€è¦</option>
                                    <option value="needed_general">âš¡ ä¸€èˆ¬éœ€è¦</option>
                                </select>
                            </div>
                        </div>
                        <div class="editor-content">
                            <div class="editor-toolbar">
                                <button class="editor-btn" id="bold-btn" title="åŠ ç²—">ğ</button>
                                <button class="editor-btn" id="italic-btn" title="æ–œä½“">ğ‘°</button>
                                <button class="editor-btn" id="underline-btn" title="ä¸‹åˆ’çº¿">ğ‘¼</button>
                                <span class="separator">|</span>
                                <button class="editor-btn" id="heading-btn" title="æ ‡é¢˜"># </button>
                                <button class="editor-btn" id="list-btn" title="åˆ—è¡¨">â€¢ </button>
                                <button class="editor-btn" id="link-btn" title="é“¾æ¥">ğŸ”—</button>
                                <span class="separator">|</span>
                                <button class="editor-btn" id="save-note" title="ä¿å­˜">ğŸ’¾</button>
                                <button class="editor-btn" id="copy-note" title="å¤åˆ¶">ğŸ“‹</button>
                                <button class="editor-btn danger" id="delete-note" title="åˆ é™¤">ğŸ—‘ï¸</button>
                            </div>
                            <textarea id="note-content" placeholder="åœ¨è¿™é‡Œè¾“å…¥ç¬”è®°å†…å®¹..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥æ¡† -->
    <div id="notification" class="notification">
        <span id="notification-text"></span>
        <button id="notification-close">âœ–ï¸</button>
    </div>

    <!-- å¯¼å…¥å¯¼å‡ºå¯¹è¯æ¡† -->
    <div id="import-export-dialog" class="dialog" style="display: none;">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>ğŸ“¦ å¯¼å…¥å¯¼å‡º</h3>
                <button class="dialog-close">âœ–ï¸</button>
            </div>
            <div class="dialog-body">
                <div class="export-section">
                    <h4>å¯¼å‡ºç¬”è®°</h4>
                    <button id="export-json" class="btn">ğŸ“„ å¯¼å‡ºä¸ºJSON</button>
                    <button id="export-markdown" class="btn">ğŸ“ å¯¼å‡ºä¸ºMarkdown</button>
                    <button id="export-html" class="btn">ğŸŒ å¯¼å‡ºä¸ºHTML</button>
                </div>
                <div class="import-section">
                    <h4>å¯¼å…¥ç¬”è®°</h4>
                    <input type="file" id="import-file" accept=".json,.md,.txt" style="margin-bottom: 10px;">
                    <button id="import-notes" class="btn btn-primary">ğŸ“¥ å¯¼å…¥ç¬”è®°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è„šæœ¬æ–‡ä»¶ -->
    <script src="scripts/moo.js"></script>
    <script src="scripts/func.js"></script>
    <script src="scripts/jquery-3.6.0.min.js"></script>
    <script src="scripts/security/xss-protection.js"></script>
    <script src="scripts/security/permission-manager.js"></script>
    <script src="scripts/security/backup-manager.js"></script>
    <script src="scripts/note-manager.js"></script>
    <script>
        // å…¨å±€æµ®åŠ¨çª—å£ä¸“ç”¨è„šæœ¬
        
        // çª—å£æ§åˆ¶å‡½æ•°
        function closeFloatingWindow() {
            window.close();
        }
        
        function minimizeFloatingWindow() {
            chrome.windows.getCurrent((window) => {
                chrome.windows.update(window.id, { state: 'minimized' });
            });
        }
        
        function toggleMaximizeFloatingWindow() {
            chrome.windows.getCurrent((window) => {
                if (window.state === 'maximized') {
                    chrome.windows.update(window.id, { state: 'normal' });
                } else {
                    chrome.windows.update(window.id, { state: 'maximized' });
                }
            });
        }
        
        // çª—å£æ§åˆ¶æŒ‰é’®æ‚¬åœæ•ˆæœ
        document.addEventListener('DOMContentLoaded', () => {
            const controlBtns = document.querySelectorAll('.floating-control-btn');
            
            controlBtns.forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    if (btn.classList.contains('close')) {
                        btn.textContent = 'âœ•';
                    } else if (btn.classList.contains('minimize')) {
                        btn.textContent = 'âˆ’';
                    } else if (btn.classList.contains('maximize')) {
                        btn.textContent = '+';
                    }
                });
                
                btn.addEventListener('mouseleave', () => {
                    btn.textContent = 'â—';
                });
            });
        });
        
        // å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFloatingWindow();
            }
        });
        
        // æ™ºèƒ½çª—å£å¯è§æ€§ç®¡ç†ï¼ˆChrome Extensionæ¨¡å¼ï¼‰
        let visibilityManager = {
            interval: null,
            isActive: false,
            lastFocusTime: Date.now(),
            
            start() {
                if (this.interval) return;
                
                console.log('[Floating] å¯åŠ¨æ™ºèƒ½å¯è§æ€§ç®¡ç†');
                this.isActive = true;
                
                // è¾ƒé¢‘ç¹çš„æ£€æŸ¥ä»¥ä¿æŒçª—å£å¯è§
                this.interval = setInterval(() => {
                    this.checkAndMaintainVisibility();
                }, 15000); // 15ç§’æ£€æŸ¥ä¸€æ¬¡
            },
            
            stop() {
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                    this.isActive = false;
                    console.log('[Floating] åœæ­¢æ™ºèƒ½å¯è§æ€§ç®¡ç†');
                }
            },
            
            checkAndMaintainVisibility() {
                chrome.windows.getCurrent((currentWindow) => {
                    if (chrome.runtime.lastError) {
                        console.log('[Floating] çª—å£æ£€æŸ¥å¤±è´¥:', chrome.runtime.lastError.message);
                        return;
                    }
                    
                    // å¦‚æœçª—å£é•¿æ—¶é—´æœªè·å¾—ç„¦ç‚¹ï¼Œå°è¯•é‡æ–°èšç„¦
                    const timeSinceLastFocus = Date.now() - this.lastFocusTime;
                    if (timeSinceLastFocus > 60000) { // 1åˆ†é’Ÿæœªèšç„¦
                        chrome.windows.update(currentWindow.id, { 
                            focused: true,
                            drawAttention: true 
                        }, () => {
                            if (!chrome.runtime.lastError) {
                                console.log('[Floating] é‡æ–°èšç„¦çª—å£ä»¥ä¿æŒå¯è§æ€§');
                                this.lastFocusTime = Date.now();
                            }
                        });
                    }
                });
            }
        };
        
        // ç›‘å¬çª—å£ç„¦ç‚¹å˜åŒ–
        window.addEventListener('focus', () => {
            visibilityManager.lastFocusTime = Date.now();
            if (!visibilityManager.isActive) {
                visibilityManager.start();
            }
        });
        
        window.addEventListener('blur', () => {
            // çª—å£å¤±å»ç„¦ç‚¹åå»¶è¿Ÿåœæ­¢ç®¡ç†ï¼ˆé¿å…é¢‘ç¹å¯åœï¼‰
            setTimeout(() => {
                if (document.hidden) {
                    visibilityManager.stop();
                }
            }, 5000);
        });
        
        // é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                visibilityManager.stop();
            } else {
                visibilityManager.start();
            }
        });
        
        // é¡µé¢åŠ è½½å®Œæˆæ—¶å¯åŠ¨
        document.addEventListener('DOMContentLoaded', () => {
            visibilityManager.start();
        });
    </script>
</body>
</html>