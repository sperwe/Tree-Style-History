<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎈 浮动笔记管理器</title>
    <link rel="stylesheet" href="css/note-manager.css">
    <style>
        /* 全局浮动窗口专用样式 */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", Helvetica, Arial, sans-serif;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
        }
        
        .floating-window-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            border: 0.5px solid rgba(0, 0, 0, 0.08);
        }
        
        .floating-title-bar {
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            border-bottom: 0.5px solid rgba(0, 0, 0, 0.08);
            -webkit-app-region: drag;
            user-select: none;
        }
        
        .floating-controls {
            display: flex;
            gap: 8px;
            -webkit-app-region: no-drag;
        }
        
        .floating-control-btn {
            width: 13px;
            height: 13px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: 500;
            color: transparent;
        }
        
        .floating-control-btn.close { background: #FF5F57; }
        .floating-control-btn.minimize { background: #FFBD2E; }
        .floating-control-btn.maximize { background: #28CA42; }
        
        .floating-control-btn:hover {
            color: rgba(0, 0, 0, 0.6);
        }
        
        .floating-title {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #1d1d1f;
            margin-right: 60px;
        }
        
        .floating-content {
            flex: 1;
            overflow: hidden;
        }
        
        /* 隐藏原来的"新窗口"按钮 */
        #open-window {
            display: none !important;
        }
        
        /* 工具栏微调 */
        .toolbar {
            padding: 12px 16px;
            background: rgba(248, 249, 250, 0.8);
        }
    </style>
</head>
<body>
    <div class="floating-window-container">
        <!-- 标题栏 -->
        <div class="floating-title-bar">
            <div class="floating-controls">
                <button class="floating-control-btn close" title="关闭" onclick="closeFloatingWindow()">●</button>
                <button class="floating-control-btn minimize" title="最小化" onclick="minimizeFloatingWindow()">●</button>
                <button class="floating-control-btn maximize" title="最大化" onclick="toggleMaximizeFloatingWindow()">●</button>
            </div>
            <div class="floating-title">🎈 浮动笔记管理器</div>
        </div>
        
        <!-- 内容区域 -->
        <div class="floating-content">
            <div class="note-manager-container">
                <!-- 顶部工具栏 -->
                <div class="toolbar">
                    <div class="toolbar-left">
                        <div class="search-box">
                            <input type="text" id="global-search" placeholder="🔍 搜索笔记标题和内容..." maxlength="100">
                            <button id="clear-search" class="clear-btn" style="display: none;">✖️</button>
                        </div>
                    </div>
                    
                    <div class="toolbar-center">
                        <div class="filters">
                            <select id="tag-filter" title="按标签过滤">
                                <option value="">🏷️ 全部标签</option>
                                <option value="important_very">🔥 非常重要</option>
                                <option value="important_somewhat">🔥 比较重要</option>
                                <option value="important_general">🔥 一般重要</option>
                                <option value="interesting_very">💡 非常有趣</option>
                                <option value="interesting_somewhat">💡 比较有趣</option>
                                <option value="interesting_general">💡 一般有趣</option>
                                <option value="needed_very">⚡ 非常需要</option>
                                <option value="needed_somewhat">⚡ 比较需要</option>
                                <option value="needed_general">⚡ 一般需要</option>
                            </select>
                            <select id="sort-filter" title="排序方式">
                                <option value="time_desc">⏰ 最新在前</option>
                                <option value="time_asc">⏰ 最旧在前</option>
                                <option value="title_asc">🔤 标题A-Z</option>
                                <option value="title_desc">🔤 标题Z-A</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="toolbar-right">
                        <button id="refresh-notes" class="btn" title="刷新笔记列表">🔄</button>
                        <button id="new-note" class="btn btn-primary" title="新建笔记">📝 新建</button>
                        <button id="toggle-preview" class="btn" title="切换预览模式">👁️</button>
                        <button id="import-export" class="btn" title="导入导出">📦</button>
                    </div>
                </div>

                <!-- 主内容区域 -->
                <div class="main-content">
                    <!-- 左侧笔记列表面板 -->
                    <div class="note-list-panel">
                        <div class="list-header">
                            <div class="list-stats">
                                <span class="stats-text">共 <span id="total-notes">0</span> 条笔记</span>
                            </div>
                            <div class="list-controls">
                                <button id="select-all-notes" class="btn-small">全选</button>
                                <button id="delete-selected" class="btn-small danger" style="display: none;">删除选中</button>
                            </div>
                        </div>
                        <div class="note-list" id="note-list">
                            <!-- 笔记列表将在这里动态生成 -->
                            <div class="loading-state" id="loading-notes" style="
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                height: 200px;
                                color: #666;
                            ">
                                <div>🔄 加载笔记中...</div>
                            </div>
                            <div class="empty-state" id="empty-notes" style="
                                display: none;
                                text-align: center;
                                padding: 40px 20px;
                                color: #666;
                            ">
                                <div style="font-size: 48px; margin-bottom: 16px;">📝</div>
                                <div style="font-size: 16px; margin-bottom: 8px;">暂无笔记</div>
                                <div style="font-size: 14px;">点击"新建"按钮创建你的第一条笔记</div>
                            </div>
                        </div>
                    </div>

                    <!-- 右侧编辑器面板 -->
                    <div class="editor-panel">
                        <div class="editor-header">
                            <div class="note-meta" id="note-meta" style="display: none;">
                                <div class="meta-row">
                                    <span class="meta-label">📄 页面:</span>
                                    <span class="meta-value" id="note-url">-</span>
                                </div>
                                <div class="meta-row">
                                    <span class="meta-label">🕒 时间:</span>
                                    <span class="meta-value" id="note-time">-</span>
                                </div>
                            </div>
                            <div class="title-input-container">
                                <input type="text" id="note-title" placeholder="输入笔记标题..." maxlength="200">
                            </div>
                            <div class="tag-selector">
                                <label for="note-tag">🏷️ 标签:</label>
                                <select id="note-tag">
                                    <option value="general_general">📋 一般</option>
                                    <option value="important_very">🔥 非常重要</option>
                                    <option value="important_somewhat">🔥 比较重要</option>
                                    <option value="important_general">🔥 一般重要</option>
                                    <option value="interesting_very">💡 非常有趣</option>
                                    <option value="interesting_somewhat">💡 比较有趣</option>
                                    <option value="interesting_general">💡 一般有趣</option>
                                    <option value="needed_very">⚡ 非常需要</option>
                                    <option value="needed_somewhat">⚡ 比较需要</option>
                                    <option value="needed_general">⚡ 一般需要</option>
                                </select>
                            </div>
                        </div>
                        <div class="editor-content">
                            <div class="editor-toolbar">
                                <button class="editor-btn" id="bold-btn" title="加粗">𝐁</button>
                                <button class="editor-btn" id="italic-btn" title="斜体">𝑰</button>
                                <button class="editor-btn" id="underline-btn" title="下划线">𝑼</button>
                                <span class="separator">|</span>
                                <button class="editor-btn" id="heading-btn" title="标题"># </button>
                                <button class="editor-btn" id="list-btn" title="列表">• </button>
                                <button class="editor-btn" id="link-btn" title="链接">🔗</button>
                                <span class="separator">|</span>
                                <button class="editor-btn" id="save-note" title="保存">💾</button>
                                <button class="editor-btn" id="copy-note" title="复制">📋</button>
                                <button class="editor-btn danger" id="delete-note" title="删除">🗑️</button>
                            </div>
                            <textarea id="note-content" placeholder="在这里输入笔记内容..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 通知框 -->
    <div id="notification" class="notification">
        <span id="notification-text"></span>
        <button id="notification-close">✖️</button>
    </div>

    <!-- 导入导出对话框 -->
    <div id="import-export-dialog" class="dialog" style="display: none;">
        <div class="dialog-content">
            <div class="dialog-header">
                <h3>📦 导入导出</h3>
                <button class="dialog-close">✖️</button>
            </div>
            <div class="dialog-body">
                <div class="export-section">
                    <h4>导出笔记</h4>
                    <button id="export-json" class="btn">📄 导出为JSON</button>
                    <button id="export-markdown" class="btn">📝 导出为Markdown</button>
                    <button id="export-html" class="btn">🌐 导出为HTML</button>
                </div>
                <div class="import-section">
                    <h4>导入笔记</h4>
                    <input type="file" id="import-file" accept=".json,.md,.txt" style="margin-bottom: 10px;">
                    <button id="import-notes" class="btn btn-primary">📥 导入笔记</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 脚本文件 -->
    <script src="scripts/moo.js"></script>
    <script src="scripts/func.js"></script>
    <script src="scripts/jquery-3.6.0.min.js"></script>
    <script src="scripts/security/xss-protection.js"></script>
    <script src="scripts/security/permission-manager.js"></script>
    <script src="scripts/security/backup-manager.js"></script>
    <script src="scripts/note-manager.js"></script>
    <script>
        // 全局浮动窗口专用脚本
        
        // 窗口控制函数
        function closeFloatingWindow() {
            window.close();
        }
        
        function minimizeFloatingWindow() {
            chrome.windows.getCurrent((window) => {
                chrome.windows.update(window.id, { state: 'minimized' });
            });
        }
        
        function toggleMaximizeFloatingWindow() {
            chrome.windows.getCurrent((window) => {
                if (window.state === 'maximized') {
                    chrome.windows.update(window.id, { state: 'normal' });
                } else {
                    chrome.windows.update(window.id, { state: 'maximized' });
                }
            });
        }
        
        // 窗口控制按钮悬停效果
        document.addEventListener('DOMContentLoaded', () => {
            const controlBtns = document.querySelectorAll('.floating-control-btn');
            
            controlBtns.forEach(btn => {
                btn.addEventListener('mouseenter', () => {
                    if (btn.classList.contains('close')) {
                        btn.textContent = '✕';
                    } else if (btn.classList.contains('minimize')) {
                        btn.textContent = '−';
                    } else if (btn.classList.contains('maximize')) {
                        btn.textContent = '+';
                    }
                });
                
                btn.addEventListener('mouseleave', () => {
                    btn.textContent = '●';
                });
            });
        });
        
        // 快捷键支持
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeFloatingWindow();
            }
        });
        
        // 定期检查窗口状态，确保保持可见性（针对不支持alwaysOnTop的情况）
        let keepOnTopInterval = null;
        
        function startKeepOnTop() {
            if (keepOnTopInterval) return;
            
            keepOnTopInterval = setInterval(() => {
                // 每30秒尝试将窗口带到前台
                chrome.windows.getCurrent((currentWindow) => {
                    if (!currentWindow.focused) {
                        chrome.windows.update(currentWindow.id, { focused: true }, () => {
                            if (chrome.runtime.lastError) {
                                console.log('[Floating] 无法聚焦窗口:', chrome.runtime.lastError.message);
                            }
                        });
                    }
                });
            }, 30000); // 30秒检查一次
        }
        
        function stopKeepOnTop() {
            if (keepOnTopInterval) {
                clearInterval(keepOnTopInterval);
                keepOnTopInterval = null;
            }
        }
        
        // 当窗口获得焦点时启动保持置顶，失去焦点时停止（节省资源）
        window.addEventListener('focus', startKeepOnTop);
        window.addEventListener('blur', stopKeepOnTop);
        
        // 页面加载完成时启动一次
        document.addEventListener('DOMContentLoaded', () => {
            startKeepOnTop();
        });
    </script>
</body>
</html>